<!DOCTYPE html>
<html lang="pt-br" class="antialiased">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Preparôh</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Ícone Personalizado -->
    <link rel="shortcut icon" href="preparoh.png" type="image/x-icon">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        primary: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95' },
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' }
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'glow': '0 0 15px rgba(139, 92, 246, 0.3)',
                        'page': '0 0 20px rgba(0,0,0,0.08)'
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL --- */
        body {
            overflow: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .dark .glass {
            background: rgba(30, 41, 59, 0.9);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* --- EDITOR A4 --- */
        #pages-container {
            outline: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        .a4-page {
            width: 210mm;
            height: 297mm;
            min-height: 297mm;
            background: white;
            padding: 25mm;
            margin: 0 auto 30px auto;
            box-shadow: var(--tw-shadow-page);
            font-family: 'Merriweather', serif;
            font-size: 11pt;
            line-height: 1.6;
            color: #1e293b;
            position: relative;
            overflow: hidden;
            cursor: text;
        }

        /* Typography inside page */
        .a4-page b,
        .a4-page strong {
            font-weight: 700;
        }

        .a4-page i,
        .a4-page em {
            font-style: italic;
        }

        .a4-page u {
            text-decoration: underline;
        }

        .a4-page ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .a4-page ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        .a4-page li {
            margin-bottom: 0.25em;
        }

        .a4-page h1 {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .a4-page h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .a4-page h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin-bottom: 0.5em;
        }

        .a4-page p {
            margin-bottom: 1em;
        }

        .a4-page blockquote {
            border-left: 3px solid #cbd5e1;
            padding-left: 1em;
            color: #64748b;
            font-style: italic;
            margin-bottom: 1em;
        }

        @media (max-width: 768px) {
            .a4-page {
                width: 95%;
                padding: 15mm;
                height: auto;
                min-height: 400px;
            }
        }

        .dark .a4-page {
            background: #18181b;
            color: #e2e8f0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .dark .a4-page blockquote {
            border-color: #475569;
            color: #94a3b8;
        }

        .annotation-highlight {
            background-color: rgba(253, 224, 71, 0.4);
            border-bottom: 2px solid #eab308;
            cursor: pointer;
            transition: background 0.2s;
        }

        .annotation-highlight:hover {
            background-color: rgba(253, 224, 71, 0.7);
        }

        .page-break-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            color: #94a3b8;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            user-select: none;
        }

        .page-break-marker::before,
        .page-break-marker::after {
            content: '';
            height: 1px;
            background: #e2e8f0;
            flex: 1;
            margin: 0 10px;
        }

        /* --- AI CHAT --- */
        .ai-msg-content {
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .ai-msg-content p {
            margin-bottom: 1.2em;
        }

        .ai-msg-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1.2em;
        }

        .ai-msg-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1.2em;
        }

        .ai-msg-content li {
            margin-bottom: 0.5em;
        }

        .ai-msg-content strong {
            font-weight: 700;
            color: inherit;
        }

        .ai-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            transform: none !important;
            border-left: none !important;
        }

        /* --- KANBAN & ANIMATIONS --- */
        .kanban-col {
            min-width: 300px;
            max-width: 320px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }
    </style>
</head>

<body
    class="bg-gray-50 text-slate-800 dark:bg-dark-bg dark:text-slate-200 transition-colors duration-300 h-screen w-screen flex font-sans selection:bg-primary-500 selection:text-white overflow-hidden">

    <!-- Config Variable -->
    <script>const apiKey = "";</script>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-6 right-6 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="App.ui.toggleMobileSidebar(false)"
        class="fixed inset-0 bg-black/50 z-30 lg:hidden hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed lg:relative w-72 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border flex flex-col z-40 transition-transform duration-300 h-full shrink-0 -translate-x-full lg:translate-x-0 shadow-2xl lg:shadow-none">
        <div
            class="h-16 flex items-center justify-between px-6 border-b border-gray-100 dark:border-dark-border shrink-0">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-600 to-indigo-700 flex items-center justify-center text-white shadow-glow">
                    <i class="fas fa-shapes text-xs"></i>
                </div>
                <div>
                    <h1 class="font-bold text-base leading-tight text-slate-900 dark:text-white">Preparôh</h1>
                </div>
            </div>
            <button onclick="App.ui.toggleMobileSidebar(false)"
                class="lg:hidden text-gray-400 hover:text-red-500 transition-colors"><i
                    class="fas fa-times"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-1" id="category-list"></div>

        <div class="p-4 border-t border-gray-100 dark:border-dark-border space-y-2">
            <button onclick="App.ui.modal('Nova Matéria', 'Nome:', val => App.ops.addCategory(val))"
                class="w-full py-2.5 rounded-lg bg-primary-50 dark:bg-white/5 border border-dashed border-primary-200 dark:border-gray-700 text-primary-700 dark:text-primary-300 hover:bg-primary-100 dark:hover:bg-white/10 transition-all flex items-center justify-center gap-2 group">
                <i class="fas fa-plus group-hover:scale-110 transition-transform"></i>
                <span class="font-semibold text-sm">Nova Matéria</span>
            </button>
            <div class="flex gap-2">
                <button onclick="App.ui.toggleTheme()"
                    class="flex-1 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-slate-500 dark:text-slate-400 transition-all flex items-center justify-center"
                    title="Alternar Tema">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                <button onclick="App.settings.open()"
                    class="flex-1 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-slate-500 dark:text-slate-400 transition-all flex items-center justify-center"
                    title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-gray-50 dark:bg-dark-bg w-full">

        <!-- Header -->
        <header
            class="h-16 bg-white/80 dark:bg-dark-surface/80 backdrop-blur border-b border-gray-200 dark:border-dark-border flex items-center justify-between px-4 lg:px-6 shrink-0 z-20">
            <div class="flex items-center gap-3 overflow-hidden flex-1 mr-4">
                <button onclick="App.ui.toggleMobileSidebar(true)"
                    class="lg:hidden text-slate-500 p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg"><i
                        class="fas fa-bars"></i></button>
                <h2 id="page-title"
                    class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2 truncate hidden md:flex">
                    <i class="fas fa-home text-slate-400 text-sm"></i> Início
                </h2>
                <div class="relative max-w-md w-full ml-2 md:ml-6 hidden sm:block">
                    <input type="text" id="global-search" oninput="App.ops.search(this.value)"
                        placeholder="Buscar notas ou tarefas..."
                        class="w-full bg-gray-100 dark:bg-black/20 border-none rounded-lg py-1.5 pl-9 pr-4 text-sm focus:ring-2 focus:ring-primary-500 dark:text-white placeholder-gray-400">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                </div>
            </div>

            <div
                class="flex items-center gap-3 bg-white dark:bg-black/20 px-3 py-1.5 rounded-full border border-gray-200 dark:border-dark-border shadow-sm">
                <button onclick="App.pomo.setCustomTime()" class="text-gray-400 hover:text-primary-500 text-xs px-1"
                    title="Definir Tempo"><i class="fas fa-clock"></i></button>
                <span id="pomo-timer" onclick="App.pomo.setCustomTime()"
                    class="font-mono font-bold text-base lg:text-lg text-primary-600 dark:text-primary-400 tabular-nums cursor-pointer hover:underline">25:00</span>
                <button onclick="App.pomo.toggle()" id="pomo-btn"
                    class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-300 flex items-center justify-center hover:scale-110 transition-transform">
                    <i class="fas fa-play text-xs ml-0.5"></i>
                </button>
                <button onclick="App.pomo.reset()"
                    class="text-gray-400 hover:text-slate-600 dark:hover:text-slate-200 px-1"><i
                        class="fas fa-redo text-xs"></i></button>
            </div>
        </header>

        <div id="search-results"
            class="absolute top-16 left-0 right-0 bg-white/95 dark:bg-dark-surface/95 backdrop-blur z-50 shadow-xl border-b border-gray-200 dark:border-dark-border max-h-96 overflow-y-auto hidden p-4">
        </div>

        <div id="empty-state"
            class="absolute inset-0 flex flex-col items-center justify-center z-10 bg-gray-50 dark:bg-dark-bg animate-enter p-6 text-center">
            <div
                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-primary-400 to-indigo-600 mb-6 shadow-glow rotate-3 flex items-center justify-center text-3xl text-white">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="text-2xl lg:text-3xl font-bold text-slate-800 dark:text-white mb-2">Preparôh</h1>
            <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-sm">Seu sistema de estudos profissional. Selecione
                ou crie uma matéria para começar.</p>
            <button onclick="App.ui.modal('Nova Matéria', 'Nome:', val => App.ops.addCategory(val))"
                class="bg-primary-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-primary-700 transition-all transform hover:-translate-y-1">Criar
                Matéria</button>
        </div>

        <div id="content-area" class="flex-1 flex flex-col hidden overflow-hidden relative z-10">
            <div
                class="px-4 lg:px-6 pt-4 flex gap-2 overflow-x-auto shrink-0 border-b border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface no-scrollbar">
                <button onclick="App.nav.tab('notes')" class="tab-btn active" data-tab="notes"><i
                        class="fas fa-file-word mr-2"></i>Documentos</button>
                <button onclick="App.nav.tab('tasks')" class="tab-btn" data-tab="tasks"><i
                        class="fas fa-check-circle mr-2"></i>Tarefas</button>
                <button onclick="App.nav.tab('files')" class="tab-btn" data-tab="files"><i
                        class="fas fa-folder-open mr-2"></i>Arquivos</button>
                <button onclick="App.nav.tab('charts')" class="tab-btn" data-tab="charts"><i
                        class="fas fa-chart-bar mr-2"></i>Gráficos</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 lg:p-8 bg-gray-50 dark:bg-dark-bg custom-scrollbar relative">
                <div id="view-notes" class="view-sect grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6 pb-20"></div>
                <div id="view-tasks" class="view-sect hidden h-full flex flex-col">
                    <div
                        class="flex-shrink-0 mb-6 bg-white dark:bg-dark-surface p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border flex flex-col md:flex-row items-center justify-center gap-8">
                        <div class="h-32 w-32 relative"><canvas id="tasks-progress-chart"></canvas></div>
                        <div class="flex flex-col text-center md:text-left">
                            <h3 class="font-bold text-lg dark:text-white">Progresso Geral</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Visão geral das suas tarefas.</p>
                            <div class="flex gap-4 mt-2 text-xs font-bold justify-center md:justify-start">
                                <span class="text-gray-500"><span
                                        class="w-2 h-2 rounded-full bg-gray-300 inline-block mr-1"></span> A
                                    Fazer</span>
                                <span class="text-blue-500"><span
                                        class="w-2 h-2 rounded-full bg-blue-400 inline-block mr-1"></span>
                                    Fazendo</span>
                                <span class="text-green-500"><span
                                        class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span> Feito</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-x-auto pb-4">
                        <div class="flex gap-4 lg:gap-6 h-full min-w-max" id="kanban-board"></div>
                    </div>
                </div>

                <!-- NEW HORIZONTAL FILES VIEW -->
                <div id="view-files" class="view-sect hidden space-y-8">
                    <!-- Global Upload Area -->
                    <div onclick="document.getElementById('file-input').click()"
                        class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl p-6 text-center cursor-pointer hover:bg-white dark:hover:bg-white/5 hover:border-primary-500 transition-all group bg-gray-50 dark:bg-transparent">
                        <i
                            class="fas fa-cloud-upload-alt text-3xl text-gray-400 group-hover:text-primary-500 mb-2 transition-colors"></i>
                        <p class="font-bold text-gray-600 dark:text-gray-300 text-sm">Clique para adicionar arquivo (Máx
                            10MB)</p>
                        <p class="text-xs text-gray-400 mt-1">O arquivo será salvo na pasta atual.</p>
                        <input type="file" id="file-input" class="hidden" multiple onchange="App.ops.handleFiles(this)">
                    </div>

                    <!-- Videos Section -->
                    <div id="section-videos"></div>

                    <!-- Images Section -->
                    <div id="section-images"></div>

                    <!-- PDFs Section -->
                    <div id="section-pdfs"></div>
                </div>

                <div id="view-charts" class="view-sect hidden">
                    <div class="flex justify-end mb-6">
                        <button onclick="App.charts.openBuilder()"
                            class="bg-primary-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-700 shadow-lg text-sm">+
                            Novo Gráfico</button>
                    </div>
                    <div id="charts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Word Editor -->
    <div id="word-editor" class="fixed inset-0 bg-gray-100 dark:bg-[#0c0c0c] z-50 hidden flex-col animate-enter">
        <div
            class="h-auto min-h-[60px] bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border flex flex-wrap items-center justify-between px-4 py-2 shrink-0 z-20 shadow-sm gap-2">
            <div class="flex items-center gap-2 lg:gap-3 flex-1 min-w-[200px]">
                <button onclick="App.editor.close()"
                    class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-slate-500 flex items-center justify-center"><i
                        class="fas fa-arrow-left"></i></button>
                <input type="text" id="doc-title"
                    class="bg-transparent font-bold text-base lg:text-lg text-slate-800 dark:text-white border-none focus:ring-0 placeholder-gray-400 w-full lg:w-64 truncate"
                    placeholder="Título do Documento">
                <span id="word-count"
                    class="text-xs text-gray-400 hidden xl:inline border-l pl-3 ml-2 border-gray-300 whitespace-nowrap">0
                    palavras</span>
            </div>
            <div
                class="flex items-center gap-1 bg-gray-50 dark:bg-black/20 p-1 rounded-lg border border-gray-200 dark:border-white/5 overflow-x-auto flex-1 max-w-full lg:max-w-max no-scrollbar mx-2">
                <button onclick="App.editor.cmd('undo')" class="tool-btn"><i class="fas fa-undo"></i></button>
                <button onclick="App.editor.cmd('redo')" class="tool-btn"><i class="fas fa-redo"></i></button>
                <div class="w-px h-5 bg-gray-300 mx-1 shrink-0"></div>
                <button onclick="App.editor.cmd('bold')" class="tool-btn font-bold">B</button>
                <button onclick="App.editor.cmd('italic')" class="tool-btn italic">I</button>
                <button onclick="App.editor.cmd('underline')" class="tool-btn underline">U</button>
                <div class="w-px h-5 bg-gray-300 mx-1 shrink-0"></div>
                <select onchange="App.editor.cmd('fontSize', this.value)"
                    class="h-8 rounded bg-transparent border border-gray-300 dark:border-gray-600 text-xs text-slate-700 dark:text-slate-300 focus:ring-0 cursor-pointer w-20 mx-1 hover:bg-gray-100 dark:hover:bg-white/5 outline-none font-medium">
                    <option value="1">Pequeno</option>
                    <option value="3" selected>Normal</option>
                    <option value="5">Médio</option>
                    <option value="6">Grande</option>
                    <option value="7">Extra</option>
                </select>
                <div class="w-px h-5 bg-gray-300 mx-1 shrink-0"></div>
                <div
                    class="relative w-8 h-8 flex items-center justify-center cursor-pointer hover:bg-gray-200 dark:hover:bg-white/10 rounded overflow-hidden">
                    <input type="color" onchange="App.editor.cmd('foreColor', this.value)"
                        class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                    <span class="font-bold text-xs text-red-500 border-b-2 border-red-500">A</span>
                </div>
                <button onclick="App.editor.cmd('removeFormat')" class="tool-btn"><i class="fas fa-eraser"></i></button>
                <div class="w-px h-5 bg-gray-300 mx-1 shrink-0"></div>
                <button onclick="App.editor.cmd('justifyLeft')" class="tool-btn"><i
                        class="fas fa-align-left"></i></button>
                <button onclick="App.editor.cmd('justifyCenter')" class="tool-btn"><i
                        class="fas fa-align-center"></i></button>
                <button onclick="App.editor.cmd('insertUnorderedList')" class="tool-btn"><i
                        class="fas fa-list-ul"></i></button>
                <div class="w-px h-5 bg-gray-300 mx-1 shrink-0"></div>
                <button onclick="App.editor.addAnnotation()"
                    class="tool-btn text-yellow-600 bg-yellow-50 hover:bg-yellow-100"><i
                        class="fas fa-comment-alt"></i></button>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="App.editor.exportWord()" class="btn-secondary text-sm px-3 hidden sm:flex"><i
                        class="fas fa-file-word text-blue-600"></i></button>
                <button onclick="App.editor.save()"
                    class="bg-primary-600 text-white rounded-lg px-4 py-2 text-sm font-bold shadow hover:bg-primary-700"><i
                        class="fas fa-save sm:mr-1"></i> <span class="hidden sm:inline">Salvar</span></button>
                <button onclick="App.editor.toggleSidebar()" class="text-slate-500 hover:text-primary-600 px-2"><i
                        class="fas fa-columns"></i></button>
            </div>
        </div>
        <div class="flex flex-1 overflow-hidden relative">
            <div id="editor-viewport" class="flex-1 overflow-y-auto p-4 lg:p-8 bg-gray-200 dark:bg-[#121212] relative"
                onclick="App.editor.checkClick(event)">
                <div id="pages-container" class="flex flex-col items-center min-h-full"></div>
                <div class="flex justify-center pb-10 mt-4">
                    <button onclick="App.editor.addPage()"
                        class="bg-gray-300 dark:bg-gray-800 text-gray-600 dark:text-gray-400 px-4 py-2 rounded-full text-sm hover:scale-105 transition-transform shadow-md font-medium">+
                        Adicionar Página</button>
                </div>
            </div>
            <div id="editor-sidebar"
                class="absolute right-0 top-0 bottom-0 w-80 bg-white dark:bg-dark-surface border-l border-gray-200 dark:border-dark-border flex flex-col shadow-xl z-30 transform translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 lg:flex"
                style="display: none;">
                <div class="flex border-b border-gray-200 dark:border-dark-border relative">
                    <button onclick="App.editor.switchSide('ai')" id="btn-side-ai"
                        class="flex-1 py-3 text-sm font-bold border-b-2 border-primary-500 text-primary-600">Tutor
                        IA</button>
                    <button onclick="App.editor.switchSide('comments')" id="btn-side-comments"
                        class="flex-1 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500">Comentários</button>
                    <button onclick="App.ui.toggleAiFullScreen()"
                        class="px-3 text-gray-400 hover:text-primary-600 transition-colors" title="Tela Cheia"><i
                            id="btn-ai-expand-icon" class="fas fa-expand"></i></button>
                    <button onclick="App.editor.toggleSidebar()" class="px-3 lg:hidden"><i
                            class="fas fa-times"></i></button>
                </div>
                <div id="panel-ai" class="flex-1 flex flex-col overflow-hidden">
                    <div id="ai-messages"
                        class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-black/20 text-sm"></div>
                    <div class="p-4 border-t border-gray-200 dark:border-dark-border">
                        <div class="flex gap-2 mb-2 overflow-x-auto no-scrollbar">
                            <button onclick="App.ai.quick('summary')"
                                class="text-[10px] bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold uppercase whitespace-nowrap">Resumir</button>
                            <button onclick="App.ai.quick('quiz')"
                                class="text-[10px] bg-pink-100 text-pink-700 px-2 py-1 rounded font-bold uppercase whitespace-nowrap">Criar
                                Quiz</button>
                            <button onclick="App.ai.quick('fix')"
                                class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold uppercase whitespace-nowrap">Corrigir</button>
                            <button onclick="App.ai.quick('analyze')"
                                class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold uppercase whitespace-nowrap">Analisar</button>
                        </div>
                        <div class="relative">
                            <input type="text" id="ai-input"
                                class="w-full pl-4 pr-10 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-white/5 text-sm focus:ring-2 focus:ring-primary-500 outline-none dark:text-white"
                                placeholder="Pergunte ao Tutor..." onkeydown="if(event.key==='Enter') App.ai.send()">
                            <button onclick="App.ai.send()"
                                class="absolute right-2 top-2 text-primary-600 hover:text-primary-700"><i
                                    class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
                <div id="panel-comments"
                    class="flex-1 overflow-y-auto p-4 space-y-3 hidden bg-gray-50 dark:bg-black/10">
                    <p class="text-xs text-center text-gray-400 mt-4">Selecione um texto e clique no ícone <i
                            class="fas fa-comment-alt"></i>.</p>
                    <div id="comments-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-input"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9000] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-enter border border-gray-200 dark:border-dark-border">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-slate-800 dark:text-white"></h3>
            <input id="modal-field"
                class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-black/20 mb-6 outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-500/20 text-slate-800 dark:text-white">
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('modal-input').classList.add('hidden')"
                    class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button id="modal-confirm"
                    class="px-6 py-2 bg-primary-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-primary-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm-dialog"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9999] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-enter border border-gray-200 dark:border-dark-border">
            <h3 class="text-xl font-bold mb-4 text-slate-800 dark:text-white">Confirmação</h3>
            <p id="confirm-msg" class="text-slate-600 dark:text-slate-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('modal-confirm-dialog').classList.add('hidden')"
                    class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400">Cancelar</button>
                <button id="btn-confirm-yes"
                    class="px-6 py-2 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-red-700">Sim,
                    Deletar</button>
            </div>
        </div>
    </div>

    <!-- Category Settings Modal -->
    <div id="modal-category-settings"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9300] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-enter border border-gray-200 dark:border-dark-border relative">
            <button onclick="document.getElementById('modal-category-settings').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 dark:text-white flex items-center gap-2"><i
                    class="fas fa-sliders-h text-slate-400"></i> Personalizar Matéria</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Nome</label>
                    <input id="cat-edit-name" type="text"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-black/20 dark:text-white text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Ícone (FontAwesome)</label>
                    <div class="flex gap-2">
                        <input id="cat-edit-icon" type="text" placeholder="Ex: fa-book"
                            class="flex-1 p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-black/20 dark:text-white text-sm">
                        <div class="w-12 h-12 flex items-center justify-center bg-gray-100 dark:bg-white/5 rounded-lg border border-gray-200 dark:border-gray-700 text-xl"
                            id="cat-icon-preview"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Cor da Pasta</label>
                    <div class="flex gap-2 flex-wrap" id="cat-color-picker">
                        <!-- Colors generated by JS -->
                    </div>
                </div>
                <button id="btn-save-cat"
                    class="w-full bg-slate-800 dark:bg-primary-600 text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition-opacity">Salvar
                    Alterações</button>
            </div>
        </div>
    </div>

    <div id="modal-settings"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[9200] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-enter border border-gray-200 dark:border-dark-border relative">
            <button onclick="document.getElementById('modal-settings').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold mb-6 dark:text-white flex items-center gap-2"><i
                    class="fas fa-cog text-slate-400"></i> Configurações</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Chave da API Gemini (IA)</label>
                    <input id="settings-api-key" type="password" placeholder="Cole sua chave API aqui..."
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-black/20 dark:text-white text-sm">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="App.settings.backup()"
                        class="flex flex-col items-center justify-center p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-primary-50 dark:hover:bg-white/5 transition-colors group">
                        <i
                            class="fas fa-download text-2xl text-primary-500 mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-sm dark:text-white">Fazer Backup</span>
                    </button>
                    <label
                        class="flex flex-col items-center justify-center p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-primary-50 dark:hover:bg-white/5 transition-colors group cursor-pointer">
                        <i
                            class="fas fa-upload text-2xl text-purple-500 mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="font-bold text-sm dark:text-white">Restaurar</span>
                        <input type="file" class="hidden" accept=".json" onchange="App.settings.restore(this)">
                    </label>
                </div>
                <button onclick="App.settings.save()"
                    class="w-full bg-slate-800 dark:bg-primary-600 text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition-opacity">Salvar
                    Configurações</button>
            </div>
        </div>
    </div>

    <!-- Chart Builder Modal -->
    <div id="modal-chart" class="fixed inset-0 bg-white dark:bg-dark-bg z-[8000] hidden flex-col w-full h-full">
        <div
            class="h-16 border-b border-gray-200 dark:border-dark-border flex items-center justify-between px-6 shrink-0 bg-white dark:bg-dark-surface">
            <h3 class="font-bold text-lg lg:text-xl dark:text-white">Criador de Gráficos</h3>
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-chart').classList.add('hidden')"
                    class="px-4 text-gray-500 text-sm font-bold">Cancelar</button>
                <button onclick="App.charts.save()"
                    class="bg-primary-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow">Salvar</button>
            </div>
        </div>
        <div class="flex-1 flex flex-col lg:flex-row h-full overflow-hidden">
            <!-- Sidebar Left -->
            <div
                class="w-full lg:w-[400px] bg-gray-50 dark:bg-black/20 border-r border-gray-200 dark:border-gray-800 p-6 overflow-y-auto shrink-0 flex flex-col gap-6">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Geral</label>
                    <input id="chart-title" type="text"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-dark-surface dark:text-white mb-3 text-sm"
                        placeholder="Título do Gráfico" oninput="App.charts.preview()">
                    <select id="chart-type"
                        class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-dark-surface dark:text-white text-sm mb-3"
                        onchange="App.charts.preview()">
                        <option value="bar">Barras</option>
                        <option value="line">Linha</option>
                        <option value="pie">Pizza</option>
                        <option value="doughnut">Rosca</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Opções</label>
                    <div class="flex gap-2 mb-3">
                        <div class="flex-1">
                            <span class="text-[10px] text-gray-500 block mb-1">Max Y</span>
                            <input type="number" id="chart-ymax"
                                class="w-full p-2 rounded-lg border dark:border-gray-700 dark:bg-dark-surface dark:text-white text-sm"
                                placeholder="Auto" oninput="App.charts.preview()">
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto min-h-[200px]">
                    <label
                        class="text-xs font-bold text-gray-400 uppercase block mb-2 flex justify-between items-center">
                        Valores & Cores
                        <button onclick="App.charts.addRow()"
                            class="text-primary-600 hover:text-primary-700 text-xs font-bold bg-primary-50 px-2 py-1 rounded">+
                            Adicionar</button>
                    </label>
                    <div id="chart-rows" class="space-y-2"></div>
                </div>
                <button onclick="App.charts.download()"
                    class="w-full bg-white dark:bg-white/5 border border-gray-300 dark:border-gray-600 text-slate-700 dark:text-white py-3 rounded-lg font-bold text-sm hover:bg-gray-100"><i
                        class="fas fa-download mr-2"></i>Baixar Imagem</button>
            </div>
            <!-- Preview Right -->
            <div class="flex-1 bg-white dark:bg-dark-bg p-8 flex items-center justify-center relative overflow-hidden">
                <div class="w-full h-full relative flex items-center justify-center">
                    <canvas id="chart-canvas" class="max-h-full max-w-full"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-quiz" class="fixed inset-0 bg-white dark:bg-dark-bg z-[9100] hidden flex-col">
        <div
            class="h-16 border-b border-gray-200 dark:border-dark-border flex items-center justify-between px-6 shrink-0 bg-white dark:bg-dark-surface">
            <h3 class="font-bold text-lg dark:text-white flex items-center gap-2"><i
                    class="fas fa-brain text-pink-500"></i> Quiz da IA</h3>
            <button onclick="document.getElementById('modal-quiz').classList.add('hidden')"
                class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 max-w-3xl mx-auto w-full">
            <div id="quiz-content" class="space-y-8"></div>
            <div id="quiz-result"
                class="hidden mt-8 p-6 rounded-xl bg-gray-100 dark:bg-white/5 border border-gray-200 dark:border-gray-700 text-center">
                <h4 class="text-2xl font-bold mb-2 dark:text-white">Resultado</h4>
                <p id="quiz-score" class="text-xl text-primary-600 font-bold mb-4"></p>
                <button onclick="document.getElementById('modal-quiz').classList.add('hidden')"
                    class="btn-secondary mx-auto">Fechar</button>
            </div>
        </div>
        <div
            class="p-4 border-t border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface flex justify-center">
            <button id="btn-check-quiz" onclick="App.ai.checkQuiz()"
                class="bg-primary-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-primary-700 text-lg">Corrigir
                Respostas</button>
        </div>
    </div>

    <div id="modal-viewer" class="fixed inset-0 bg-black/90 z-[9500] hidden flex-col">
        <div class="h-14 flex justify-between items-center px-4">
            <span class="text-white font-bold truncate max-w-[80%]" id="viewer-title">Visualizador</span>
            <button onclick="document.getElementById('modal-viewer').classList.add('hidden')"
                class="text-white p-2 hover:bg-white/10 rounded-full"><i class="fas fa-times"></i></button>
        </div>
        <div id="viewer-content" class="flex-1 flex items-center justify-center p-2 lg:p-4 overflow-hidden"></div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- DATABASE WRAPPER (INDEXED DB) ---
        const DB = {
            name: 'PreparohDB',
            version: 1,
            storeName: 'state',
            db: null,

            open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.name, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject('Erro ao abrir DB');
                });
            },

            async get(key) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },

            async set(key, value) {
                if (!this.db) await this.open();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const req = store.put(value, key);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }
        };

        const App = {
            data: {
                categories: [],
                content: {},
                activeCatId: null,
                activeTab: 'notes',
                theme: 'light',
                apiKey: '',
                currentDocId: null,
                chartInstances: {},
                currentQuiz: null
            },
            state: {
                filesCurrentFolder: { videos: null, images: null, pdfs: null }
            },
            saveTimeout: null,

            async init() {
                try {
                    // Try Loading from DB
                    let saved = await DB.get('root');

                    // Migration Logic: Check if LocalStorage has old data and DB is empty
                    if (!saved) {
                        const legacyV7 = localStorage.getItem('preparoh_ultimate_v7');
                        const legacyV6 = localStorage.getItem('preparoh_ultimate_v6');

                        if (legacyV7) {
                            saved = JSON.parse(legacyV7);
                            await DB.set('root', saved);
                            localStorage.removeItem('preparoh_ultimate_v7');
                        } else if (legacyV6) {
                            saved = JSON.parse(legacyV6);
                            saved.chartInstances = {};
                            await DB.set('root', saved);
                            localStorage.removeItem('preparoh_ultimate_v6');
                        }
                    }

                    if (saved) {
                        this.data = { ...this.data, ...saved, chartInstances: {} };
                    }

                    this.sanitizeData();
                } catch (e) { console.error("Load error", e); }

                if (this.data.theme === 'dark') document.documentElement.classList.add('dark');
                this.ui.renderSidebar();

                if (this.data.apiKey) window.userApiKey = this.data.apiKey;

                if (this.data.activeCatId && this.data.categories.find(c => c.id === this.data.activeCatId)) {
                    this.nav.select(this.data.activeCatId);
                } else if (this.data.categories.length > 0) {
                    this.nav.select(this.data.categories[0].id);
                } else {
                    this.ui.checkEmpty();
                }

                setInterval(() => App.pomo.tick(), 1000);

                // FIX 1: Paste Listener with enhanced color stripping
                document.getElementById('editor-viewport').addEventListener('paste', function (e) {
                    if (e.target.isContentEditable) {
                        e.preventDefault();
                        e.stopPropagation();

                        const clipboardData = (e.originalEvent || e).clipboardData;
                        let content = clipboardData.getData('text/html');

                        // Fallback to text if no HTML
                        if (!content) content = clipboardData.getData('text/plain');
                        else {
                            // Enhanced Sanitization: Strip forced colors
                            content = content.replace(/background-color:\s*[^;"]+;?/gi, '');
                            content = content.replace(/background:\s*[^;"]+;?/gi, '');
                            content = content.replace(/color:\s*[^;"]+;?/gi, ''); // NEW: Strip text color so it inherits theme
                        }

                        document.execCommand('insertHTML', false, content);

                        setTimeout(() => {
                            App.editor.sanitizeStructure();
                            App.editor.checkAllOverflows();
                        }, 10);
                    }
                });
            },

            sanitizeData() {
                if (this.data.content) {
                    Object.keys(this.data.content).forEach(k => {
                        const c = this.data.content[k];
                        if (!c.tasks || Array.isArray(c.tasks)) c.tasks = { todo: [], doing: [], done: [] };
                        if (!c.tasks.todo) c.tasks.todo = [];
                        if (!c.tasks.doing) c.tasks.doing = [];
                        if (!c.tasks.done) c.tasks.done = [];
                        if (!c.videos) c.videos = [];
                        // Migration for folders
                        if (!c.folders) c.folders = [];
                    });
                }
                // Migration for Categories (Icon/Color)
                if (this.data.categories) {
                    this.data.categories.forEach(c => {
                        if (!c.icon) c.icon = 'fa-folder';
                        if (!c.color) c.color = 'text-primary-500';
                    });
                }
            },

            persist() {
                const { chartInstances, currentQuiz, currentQuizData, ...toSave } = this.data;
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(async () => {
                    try { await DB.set('root', toSave); }
                    catch (e) { App.ui.toast("Erro ao salvar no banco de dados.", "error"); }
                }, 1000);
            },

            nav: {
                select(id) {
                    App.data.activeCatId = id;
                    App.ui.renderSidebar();
                    App.ui.checkEmpty();
                    const cat = App.data.categories.find(c => c.id === id);
                    if (cat) $('page-title').innerHTML = `<i class="fas ${cat.icon || 'fa-folder'} ${cat.color || 'text-slate-400'} text-sm mr-2"></i> ${cat.name}`;
                    this.tab(App.data.activeTab);
                    App.ui.toggleMobileSidebar(false);
                },
                tab(name) {
                    App.data.activeTab = name;
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.className = `tab-btn px-4 py-2.5 text-sm font-semibold rounded-t-lg transition-all border-b-2 shrink-0 whitespace-nowrap ${b.dataset.tab === name
                            ? 'border-primary-500 text-primary-600 bg-primary-50/50 dark:bg-white/5 dark:text-primary-400'
                            : 'border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`;
                    });
                    document.querySelectorAll('.view-sect').forEach(el => el.classList.add('hidden'));
                    $(`view-${name}`).classList.remove('hidden');
                    if (App.render[name]) App.render[name]();
                    App.persist();
                }
            },

            ui: {
                confirm(msg, callback) {
                    $('confirm-msg').innerText = msg;
                    $('modal-confirm-dialog').classList.remove('hidden');
                    $('modal-confirm-dialog').classList.add('flex');
                    const btn = $('btn-confirm-yes');
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        callback();
                        $('modal-confirm-dialog').classList.add('hidden');
                    };
                },
                toggleTheme() {
                    document.documentElement.classList.toggle('dark');
                    App.data.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                    App.persist();
                },
                toggleMobileSidebar(show) {
                    const sb = $('sidebar');
                    const ov = $('sidebar-overlay');
                    if (show) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
                    else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
                },
                checkEmpty() {
                    $('empty-state').style.display = App.data.activeCatId ? 'none' : 'flex';
                    $('content-area').style.display = App.data.activeCatId ? 'flex' : 'none';
                },
                toggleAiFullScreen() {
                    const sb = $('editor-sidebar');
                    const btn = $('btn-ai-expand-icon');
                    const isFull = sb.classList.contains('ai-fullscreen');
                    if (isFull) {
                        sb.classList.remove('ai-fullscreen');
                        sb.classList.add('absolute', 'w-80', 'right-0', 'top-0', 'bottom-0', 'border-l', 'transform', 'duration-300', 'lg:flex', 'lg:translate-x-0', 'lg:relative');
                        btn.classList.remove('fa-compress'); btn.classList.add('fa-expand');
                    } else {
                        sb.classList.remove('absolute', 'w-80', 'right-0', 'top-0', 'bottom-0', 'border-l', 'transform', 'duration-300', 'lg:flex', 'lg:translate-x-0', 'lg:relative');
                        sb.classList.add('ai-fullscreen');
                        btn.classList.remove('fa-expand'); btn.classList.add('fa-compress');
                    }
                },
                renderSidebar() {
                    const list = $('category-list');
                    list.innerHTML = '';
                    App.data.categories.forEach(c => {
                        const active = App.data.activeCatId === c.id;
                        const icon = c.icon || 'fa-folder';
                        const color = c.color || 'text-primary-500';

                        const div = document.createElement('div');
                        div.className = `group flex items-center justify-between px-3 py-2.5 rounded-lg cursor-pointer transition-all ${active ? 'bg-primary-600 text-white shadow-md' : 'hover:bg-gray-100 dark:hover:bg-white/5 text-slate-600 dark:text-slate-300'}`;
                        div.onclick = () => App.nav.select(c.id);

                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = "flex gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity p-1 z-10";

                        const settingsBtn = document.createElement('button');
                        settingsBtn.className = "hover:text-blue-400 transition-colors";
                        settingsBtn.innerHTML = '<i class="fas fa-cog text-xs"></i>';
                        settingsBtn.onclick = (e) => { e.stopPropagation(); App.ops.openCategorySettings(c.id); };

                        const delBtn = document.createElement('button');
                        delBtn.className = "hover:text-red-400 transition-colors";
                        delBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                        delBtn.onclick = (e) => { e.stopPropagation(); App.ops.delCategory(c.id); };

                        actionsDiv.appendChild(settingsBtn);
                        actionsDiv.appendChild(delBtn);

                        const contentDiv = document.createElement('div');
                        contentDiv.className = "flex items-center gap-3 overflow-hidden";
                        contentDiv.innerHTML = `<i class="fas ${icon} ${active ? 'text-white' : color}"></i><span class="truncate font-medium text-sm">${c.name}</span>`;

                        div.appendChild(contentDiv); div.appendChild(actionsDiv); list.appendChild(div);
                    });
                },
                modal(title, placeholder, callback, initialValue = '') {
                    $('modal-title').innerText = title;
                    $('modal-field').placeholder = placeholder;
                    $('modal-field').value = initialValue;
                    $('modal-input').classList.remove('hidden');
                    $('modal-input').classList.add('flex');
                    setTimeout(() => $('modal-field').focus(), 100);

                    const btn = $('modal-confirm');
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        if ($('modal-field').value.trim()) {
                            callback($('modal-field').value.trim());
                            $('modal-input').classList.add('hidden');
                        }
                    };
                },
                toast(msg, type = 'success') {
                    const div = document.createElement('div');
                    const colors = type === 'error' ? 'bg-red-500' : 'bg-slate-800 dark:bg-white dark:text-black';
                    div.className = `${colors} text-white px-6 py-3 rounded-xl shadow-xl font-bold text-sm flex items-center gap-3 animate-enter z-[9999]`;
                    div.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> ${msg}`;
                    $('toast-container').appendChild(div);
                    setTimeout(() => div.remove(), 3000);
                }
            },

            settings: {
                open() {
                    $('settings-api-key').value = App.data.apiKey || '';
                    $('modal-settings').classList.remove('hidden');
                    $('modal-settings').classList.add('flex');
                },
                save() {
                    App.data.apiKey = $('settings-api-key').value.trim();
                    window.userApiKey = App.data.apiKey;
                    App.persist();
                    $('modal-settings').classList.add('hidden');
                    App.ui.toast("Configurações salvas!");
                },
                backup() {
                    try {
                        const { chartInstances, currentQuiz, currentQuizData, ...toSave } = App.data;
                        const dataStr = JSON.stringify(toSave);
                        const blob = new Blob([dataStr], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const downloadAnchorNode = document.createElement('a');
                        downloadAnchorNode.setAttribute("href", url);
                        downloadAnchorNode.setAttribute("download", "preparoh_backup_" + new Date().toISOString().slice(0, 10) + ".json");
                        document.body.appendChild(downloadAnchorNode);
                        downloadAnchorNode.click();
                        downloadAnchorNode.remove();
                        URL.revokeObjectURL(url);
                        App.ui.toast("Backup criado com sucesso!");
                    } catch (e) { console.error(e); App.ui.toast("Erro ao criar backup.", "error"); }
                },
                restore(input) {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.categories && data.content) {
                                App.data = data;
                                App.persist(); // Saves to IndexedDB immediately
                                App.ui.toast("Restaurando...", "success");
                                setTimeout(() => window.location.reload(), 500);
                            } else { App.ui.toast("Arquivo inválido", "error"); }
                        } catch (err) { App.ui.toast("Erro ao ler arquivo", "error"); }
                    };
                    reader.readAsText(file);
                    input.value = '';
                }
            },

            ops: {
                addCategory(name) {
                    const id = uuid();
                    App.data.categories.push({ id, name, icon: 'fa-folder', color: 'text-primary-500' });
                    App.data.content[id] = { notes: [], tasks: { todo: [], doing: [], done: [] }, files: [], folders: [], videos: [], charts: [], chat: [] };
                    App.persist();
                    App.ui.renderSidebar();
                    App.nav.select(id);
                },
                delCategory(id) {
                    App.ui.confirm('Tem certeza? Isso apaga tudo nesta matéria.', () => {
                        App.data.categories = App.data.categories.filter(c => c.id !== id);
                        delete App.data.content[id];
                        if (App.data.activeCatId === id) App.data.activeCatId = null;
                        App.persist();
                        App.ui.renderSidebar();
                        if (App.data.categories.length > 0) { App.nav.select(App.data.categories[0].id); }
                        else { App.ui.checkEmpty(); }
                    });
                },
                openCategorySettings(id) {
                    const cat = App.data.categories.find(c => c.id === id);
                    if (!cat) return;
                    $('cat-edit-name').value = cat.name;
                    $('cat-edit-icon').value = cat.icon || 'fa-folder';

                    const colors = ['text-primary-500', 'text-red-500', 'text-green-500', 'text-blue-500', 'text-yellow-500', 'text-purple-500', 'text-pink-500', 'text-gray-500'];
                    const picker = $('cat-color-picker');
                    picker.innerHTML = '';
                    colors.forEach(c => {
                        const btn = document.createElement('div');
                        btn.className = `w-8 h-8 rounded-full cursor-pointer border-2 ${c.replace('text-', 'bg-')} ${cat.color === c ? 'border-black dark:border-white scale-110' : 'border-transparent'}`;
                        btn.onclick = () => {
                            cat.color = c;
                            App.ops.openCategorySettings(id); // Re-render to show selection
                        };
                        picker.appendChild(btn);
                    });

                    $('cat-icon-preview').innerHTML = `<i class="fas ${cat.icon || 'fa-folder'} ${cat.color} text-2xl"></i>`;
                    $('cat-edit-icon').oninput = (e) => {
                        $('cat-icon-preview').innerHTML = `<i class="fas ${e.target.value} ${cat.color} text-2xl"></i>`;
                    };

                    const saveBtn = $('btn-save-cat');
                    const newBtn = saveBtn.cloneNode(true);
                    saveBtn.parentNode.replaceChild(newBtn, saveBtn);
                    newBtn.onclick = () => {
                        cat.name = $('cat-edit-name').value;
                        cat.icon = $('cat-edit-icon').value;
                        // color already set
                        App.persist();
                        App.ui.renderSidebar();
                        $('modal-category-settings').classList.add('hidden');
                        if (App.data.activeCatId === id) App.nav.select(id); // Refresh title
                    };

                    $('modal-category-settings').classList.remove('hidden');
                    $('modal-category-settings').classList.add('flex');
                },
                // --- FILE / FOLDER OPS ---
                addFolder(section) {
                    App.ui.modal('Nova Pasta', 'Nome da pasta...', (name) => {
                        const content = App.data.content[App.data.activeCatId];
                        const currentParent = App.state.filesCurrentFolder[section];
                        content.folders.push({
                            id: uuid(),
                            name,
                            section,
                            parentId: currentParent
                        });
                        App.persist();
                        App.render.files();
                    });
                },
                openFolder(section, folderId) {
                    App.state.filesCurrentFolder[section] = folderId;
                    App.render.files();
                },
                goUpFolder(section) {
                    const content = App.data.content[App.data.activeCatId];
                    const currentFolder = content.folders.find(f => f.id === App.state.filesCurrentFolder[section]);
                    if (currentFolder) {
                        App.state.filesCurrentFolder[section] = currentFolder.parentId;
                        App.render.files();
                    }
                },
                delFolder(id, section) {
                    App.ui.confirm('Excluir pasta inteira?', () => {
                        // Simple delete (orphans files, but for simplicity we allow it or clear them)
                        App.data.content[App.data.activeCatId].folders = App.data.content[App.data.activeCatId].folders.filter(f => f.id !== id);
                        App.persist();
                        App.render.files();
                    });
                },
                delFile(idx) {
                    App.data.content[App.data.activeCatId].files.splice(idx, 1);
                    App.persist();
                    App.render.files();
                },
                promptAddVideo() {
                    App.ui.modal('URL do Vídeo', 'Cole a URL do YouTube...', (url) => {
                        if (!url) return;
                        setTimeout(() => {
                            App.ui.modal('Nome do Vídeo', 'Digite o título...', (name) => {
                                App.ops.addVideoLink(url, name);
                            }, 'Vídeo Novo');
                        }, 300);
                    });
                },
                addVideoLink(url, name) {
                    if (!url) return;
                    let thumb = null;
                    let isYt = false;
                    const ytMatch = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                    if (ytMatch) {
                        thumb = `https://img.youtube.com/vi/${ytMatch[1]}/hqdefault.jpg`;
                        isYt = true;
                    }

                    // Add to current video folder
                    const folderId = App.state.filesCurrentFolder['videos'];

                    App.data.content[App.data.activeCatId].videos.push({
                        id: uuid(),
                        url: url,
                        thumb: thumb,
                        name: name || "Vídeo",
                        folderId: folderId
                    });
                    App.persist();
                    App.render.files();
                },
                delVideo(idx) {
                    App.data.content[App.data.activeCatId].videos.splice(idx, 1);
                    App.persist();
                    App.render.files();
                },
                handleFiles(input) {
                    Array.from(input.files).forEach(file => {
                        if (file.size > 10485760) {
                            App.ui.toast(`Arquivo ${file.name} muito grande! Máx 10MB.`, "error");
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const type = file.type.includes('image') ? 'images' : 'pdfs';
                                const folderId = App.state.filesCurrentFolder[type]; // Add to active folder of that type

                                App.data.content[App.data.activeCatId].files.push({
                                    id: uuid(),
                                    name: file.name,
                                    type: file.type,
                                    data: e.target.result,
                                    folderId: folderId
                                });
                                App.persist();
                                App.render.files();
                            } catch (err) { App.ui.toast("Erro ao processar arquivo.", "error"); }
                        };
                        reader.readAsDataURL(file);
                    });
                    input.value = '';
                },
                search(query) {
                    const box = $('search-results');
                    if (!query || query.length < 2) { box.classList.add('hidden'); return; }
                    const q = query.toLowerCase();
                    let results = [];
                    App.data.categories.forEach(cat => {
                        const content = App.data.content[cat.id];
                        content.notes.forEach(n => {
                            if (n.title.toLowerCase().includes(q) || n.pages.some(p => p.toLowerCase().includes(q))) {
                                results.push({ type: 'doc', title: n.title, sub: cat.name, id: n.id, catId: cat.id });
                            }
                        });
                        ['todo', 'doing', 'done'].forEach(status => {
                            content.tasks[status].forEach(t => {
                                if (t.toLowerCase().includes(q)) {
                                    results.push({ type: 'task', title: t, sub: `${cat.name} (${status})`, catId: cat.id });
                                }
                            });
                        });
                    });
                    if (results.length === 0) { box.innerHTML = '<p class="text-gray-500 text-sm p-2">Nada encontrado.</p>'; }
                    else {
                        box.innerHTML = results.map(r => `
                            <div onclick="App.ops.goTo('${r.catId}', '${r.type}', '${r.id}')" class="p-3 hover:bg-gray-50 dark:hover:bg-white/5 rounded cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-0">
                                <div class="font-bold text-sm text-slate-800 dark:text-white"><i class="fas ${r.type === 'doc' ? 'fa-file-alt text-blue-500' : 'fa-check text-green-500'} mr-2"></i>${r.title}</div>
                                <div class="text-xs text-gray-400 ml-6">${r.sub}</div>
                            </div>
                        `).join('');
                    }
                    box.classList.remove('hidden');
                },
                goTo(catId, type, itemId) {
                    $('search-results').classList.add('hidden');
                    $('global-search').value = '';
                    App.nav.select(catId);
                    if (type === 'doc') { App.nav.tab('notes'); App.editor.open(itemId); }
                    else { App.nav.tab('tasks'); }
                }
            },

            // FIX 3: Reconstructed Tasks Object
            tasks: {
                add(col, text) {
                    if (!text) return;
                    const catId = App.data.activeCatId;
                    if (!App.data.content[catId].tasks[col]) App.data.content[catId].tasks[col] = [];
                    App.data.content[catId].tasks[col].push(text);
                    App.persist();
                    App.render.tasks();
                },
                del(col, idx) {
                    App.ui.confirm('Excluir tarefa?', () => {
                        const catId = App.data.activeCatId;
                        App.data.content[catId].tasks[col].splice(idx, 1);
                        App.persist();
                        App.render.tasks();
                    });
                },
                edit(col, idx, newVal) {
                    if (!newVal) return;
                    const catId = App.data.activeCatId;
                    App.data.content[catId].tasks[col][idx] = newVal;
                    App.persist();
                    App.render.tasks();
                },
                move(fromCol, fromIdx, toCol) {
                    const catId = App.data.activeCatId;
                    const item = App.data.content[catId].tasks[fromCol][fromIdx];
                    App.data.content[catId].tasks[fromCol].splice(fromIdx, 1); // Remove from old
                    if (!App.data.content[catId].tasks[toCol]) App.data.content[catId].tasks[toCol] = [];
                    App.data.content[catId].tasks[toCol].push(item); // Add to new
                    App.persist();
                    App.render.tasks();
                }
            },

            render: {
                notes() {
                    const grid = $('view-notes');
                    grid.innerHTML = `
                        <div onclick="App.editor.open()" class="h-56 rounded-2xl border-2 border-dashed border-gray-300 dark:border-gray-700 hover:border-primary-500 hover:bg-white dark:hover:bg-white/5 flex flex-col items-center justify-center cursor-pointer transition-all group">
                            <div class="w-12 h-12 rounded-full bg-primary-50 dark:bg-primary-900/20 text-primary-500 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i class="fas fa-plus"></i></div>
                            <span class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Novo Documento</span>
                        </div>
                    `;
                    const notes = App.data.content[App.data.activeCatId].notes || [];
                    notes.forEach(n => {
                        const card = document.createElement('div');
                        card.className = "bg-white dark:bg-dark-surface p-5 rounded-2xl shadow-soft hover:shadow-lg transition-all border border-gray-100 dark:border-dark-border cursor-pointer h-56 flex flex-col relative group";
                        const tempDiv = document.createElement('div'); tempDiv.innerHTML = n.pages?.[0] || "";
                        const txt = tempDiv.innerText.substring(0, 80) + "...";

                        const delBtn = document.createElement('button');
                        delBtn.className = "text-red-400 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity hover:text-red-600 z-10";
                        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        delBtn.onclick = (e) => { e.stopPropagation(); App.editor.delete(n.id); };

                        card.innerHTML = `
                            <div class="flex-1 overflow-hidden">
                                <h4 class="font-bold text-base text-slate-800 dark:text-white truncate mb-2">${n.title}</h4>
                                <p class="text-xs text-gray-400 font-serif leading-relaxed line-clamp-4">${txt}</p>
                            </div>
                            <div class="mt-3 flex justify-between items-center pt-3 border-t border-gray-100 dark:border-white/5">
                                <span class="text-[10px] text-gray-400">${new Date(n.updated).toLocaleDateString()}</span>
                            </div>
                        `;
                        card.querySelector('.mt-3').appendChild(delBtn);
                        card.onclick = () => App.editor.open(n.id);
                        grid.appendChild(card);
                    });
                },
                tasks() {
                    const board = $('kanban-board');
                    board.innerHTML = '';
                    const tasks = App.data.content[App.data.activeCatId].tasks || { todo: [], doing: [], done: [] };
                    const cols = [
                        { id: 'todo', name: 'A Fazer', color: 'bg-gray-100', dot: 'bg-gray-400' },
                        { id: 'doing', name: 'Fazendo', color: 'bg-blue-50', dot: 'bg-blue-500' },
                        { id: 'done', name: 'Feito', color: 'bg-green-50', dot: 'bg-green-500' }
                    ];

                    const ctxCanvas = $('tasks-progress-chart');
                    const existingChart = Chart.getChart(ctxCanvas);
                    if (existingChart) existingChart.destroy();

                    const todoC = tasks.todo ? tasks.todo.length : 0;
                    const doingC = tasks.doing ? tasks.doing.length : 0;
                    const doneC = tasks.done ? tasks.done.length : 0;

                    new Chart(ctxCanvas, {
                        type: 'doughnut',
                        data: { labels: ['A Fazer', 'Fazendo', 'Feito'], datasets: [{ data: [todoC, doingC, doneC], backgroundColor: ['#d1d5db', '#60a5fa', '#22c55e'], borderWidth: 0 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
                    });

                    cols.forEach(c => {
                        const colDiv = document.createElement('div');
                        colDiv.className = "kanban-col flex flex-col bg-white dark:bg-dark-surface rounded-2xl p-4 h-full border border-gray-200 dark:border-dark-border shadow-sm";
                        colDiv.innerHTML = `
                            <div class="flex justify-between items-center mb-4 px-1">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-xs uppercase tracking-wider flex items-center gap-2"><span class="w-2 h-2 rounded-full ${c.dot}"></span> ${c.name}</h3>
                                <span class="bg-gray-100 dark:bg-white/10 text-[10px] px-2 py-0.5 rounded-full font-bold text-slate-600 dark:text-slate-300">${tasks[c.id] ? tasks[c.id].length : 0}</span>
                            </div>
                            <div class="flex-1 overflow-y-auto space-y-2 custom-scrollbar min-h-[50px]" id="col-${c.id}"></div>
                            <button onclick="App.ui.modal('Nova Tarefa', 'Descrição:', val => App.tasks.add('${c.id}', val))" class="mt-2 py-2 rounded-lg border border-dashed border-gray-300 hover:bg-gray-50 dark:hover:bg-white/10 text-gray-500 text-xs font-medium transition-colors">+ Adicionar</button>
                        `;
                        const listDiv = colDiv.querySelector(`#col-${c.id}`);

                        if (tasks[c.id]) {
                            tasks[c.id].forEach((t, idx) => {
                                const card = document.createElement('div');
                                card.className = "bg-gray-50 dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-white/5 cursor-grab active:cursor-grabbing group hover:shadow-md transition-shadow select-none relative";
                                card.draggable = true;
                                card.innerHTML = `<p class="text-sm font-medium text-slate-700 dark:text-slate-200 leading-snug pointer-events-none pr-4">${t}</p>`;

                                const delBtn = document.createElement('button');
                                delBtn.className = "absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity text-gray-300 hover:text-red-500";
                                delBtn.innerHTML = '<i class="fas fa-times"></i>';
                                delBtn.onclick = () => App.tasks.del(c.id, idx);

                                card.appendChild(delBtn);
                                card.ondblclick = () => App.ui.modal('Editar Tarefa', 'Descrição:', (val) => App.tasks.edit(c.id, idx, val), t);
                                card.ondragstart = (e) => { e.dataTransfer.setData('text/plain', JSON.stringify({ col: c.id, idx })); };
                                listDiv.appendChild(card);
                            });
                        }

                        listDiv.ondragover = e => e.preventDefault();
                        listDiv.ondrop = e => {
                            e.preventDefault();
                            try {
                                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                App.tasks.move(data.col, data.idx, c.id);
                            } catch (err) { }
                        };
                        board.appendChild(colDiv);
                    });
                },
                // NEW: REFACTORED FILES RENDERER WITH HORIZONTAL SCROLL AND FOLDERS
                files() {
                    const renderSection = (sectionId, title, iconClass, items, createFn) => {
                        const container = $(`section-${sectionId}`);
                        if (!container) {
                            const wrapper = document.createElement('div');
                            wrapper.id = `section-${sectionId}`;
                            wrapper.className = "mb-8";
                            $('view-files').appendChild(wrapper);
                            // Re-select
                            return renderSection(sectionId, title, iconClass, items, createFn);
                        }

                        container.innerHTML = '';
                        const currentFolderId = App.state.filesCurrentFolder[sectionId];
                        const contentData = App.data.content[App.data.activeCatId];

                        // Header
                        const header = document.createElement('div');
                        header.className = "flex items-center justify-between border-b dark:border-gray-700 pb-2 mb-3";

                        // Breadcrumb logic
                        let pathHtml = `<span class="cursor-pointer hover:underline" onclick="App.ops.openFolder('${sectionId}', null)">${title}</span>`;
                        if (currentFolderId) {
                            const folder = contentData.folders.find(f => f.id === currentFolderId);
                            if (folder) pathHtml += ` <span class="text-gray-400">/</span> <span class="font-bold">${folder.name}</span>`;
                        }

                        header.innerHTML = `
                            <h3 class="font-bold text-slate-700 dark:text-white flex items-center gap-2 text-sm">
                                <i class="${iconClass}"></i> ${pathHtml}
                            </h3>
                            <div class="flex gap-2">
                                ${currentFolderId ? `<button onclick="App.ops.goUpFolder('${sectionId}')" class="text-xs bg-gray-100 dark:bg-white/10 px-3 py-1.5 rounded-lg font-bold hover:bg-gray-200 transition-colors"><i class="fas fa-level-up-alt"></i> Voltar</button>` : ''}
                                <button onclick="App.ops.addFolder('${sectionId}')" class="text-xs bg-primary-50 dark:bg-primary-900/30 text-primary-600 px-3 py-1.5 rounded-lg font-bold hover:bg-primary-100 transition-colors"><i class="fas fa-folder-plus"></i> Pasta</button>
                                ${sectionId === 'videos' ? `<button onclick="App.ops.promptAddVideo()" class="text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-lg font-bold hover:bg-red-100 transition-colors">+ Link</button>` : ''}
                            </div>
                        `;
                        container.appendChild(header);

                        // Horizontal Scroll Container
                        const scrollBox = document.createElement('div');
                        scrollBox.className = "flex overflow-x-auto gap-4 p-2 custom-scrollbar min-h-[140px] items-start";
                        // Horizontal scroll with mouse wheel
                        scrollBox.addEventListener('wheel', (evt) => {
                            if (evt.deltaY !== 0) {
                                evt.preventDefault();
                                scrollBox.scrollLeft += evt.deltaY;
                            }
                        }, { passive: false });

                        // Filter Items (Folders first)
                        const folders = contentData.folders.filter(f => f.section === sectionId && f.parentId === currentFolderId);

                        // Filter Files based on section type
                        let viewFiles = [];
                        if (sectionId === 'videos') {
                            viewFiles = contentData.videos.filter(v => (v.folderId || null) === currentFolderId);
                        } else {
                            // files array contains both images and pdfs, need to filter by mime type AND folder
                            viewFiles = contentData.files.filter(f => {
                                const isTargetType = sectionId === 'images' ? f.type.includes('image') : !f.type.includes('image'); // simplified logic
                                return isTargetType && (f.folderId || null) === currentFolderId;
                            });
                        }

                        if (folders.length === 0 && viewFiles.length === 0) {
                            scrollBox.innerHTML = '<div class="w-full text-center text-gray-400 text-sm italic py-8">Pasta vazia.</div>';
                        } else {
                            // Render Folders
                            folders.forEach(folder => {
                                const div = document.createElement('div');
                                div.className = "flex-shrink-0 w-32 flex flex-col gap-2 group cursor-pointer";
                                div.onclick = () => App.ops.openFolder(sectionId, folder.id);
                                div.innerHTML = `
                                    <div class="w-32 h-24 bg-primary-50 dark:bg-white/5 rounded-xl border-2 border-dashed border-primary-200 dark:border-gray-700 flex items-center justify-center text-3xl text-primary-300 group-hover:text-primary-500 group-hover:bg-primary-100 transition-colors relative">
                                        <i class="fas fa-folder"></i>
                                        <button onclick="event.stopPropagation(); App.ops.delFolder('${folder.id}', '${sectionId}')" class="absolute top-1 right-1 text-gray-400 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
                                    </div>
                                    <span class="text-xs font-bold text-center truncate px-1 text-slate-600 dark:text-slate-300">${folder.name}</span>
                                `;
                                scrollBox.appendChild(div);
                            });

                            // Render Files
                            viewFiles.forEach((item, idx) => {
                                // Find real index in main array for deletion
                                const realIndex = sectionId === 'videos'
                                    ? contentData.videos.findIndex(x => x.id === item.id)
                                    : contentData.files.findIndex(x => x.id === item.id);

                                const div = document.createElement('div');
                                div.className = "flex-shrink-0 w-40 group relative";

                                // Card Content
                                let innerHTML = '';
                                if (sectionId === 'videos') {
                                    if (item.thumb) innerHTML = `<a href="${item.url}" target="_blank" class="w-40 h-24 block bg-cover bg-center rounded-xl shadow-sm hover:scale-105 transition-transform" style="background-image:url('${item.thumb}');"><div class="absolute inset-0 flex items-center justify-center bg-black/20 hover:bg-black/0 rounded-xl"><i class="fas fa-play-circle text-2xl text-white"></i></div></a>`;
                                    else innerHTML = `<a href="${item.url}" target="_blank" class="w-40 h-24 flex flex-col items-center justify-center bg-slate-100 dark:bg-white/5 rounded-xl shadow-sm hover:text-red-500 text-slate-400 transition-colors"><i class="fas fa-video text-2xl"></i></a>`;
                                } else if (sectionId === 'images') {
                                    innerHTML = `<div class="w-40 h-24 bg-cover bg-center rounded-xl shadow-sm hover:scale-105 transition-transform cursor-pointer" style="background-image:url('${item.data}')" onclick="App.viewer.open('${item.data}','img','${item.name}')"></div>`;
                                } else {
                                    innerHTML = `<div class="w-40 h-24 flex flex-col items-center justify-center bg-red-50 dark:bg-white/5 text-red-500 rounded-xl shadow-sm hover:bg-red-100 cursor-pointer" onclick="App.viewer.openPDF('${item.data}')"><i class="fas fa-file-pdf text-2xl"></i></div>`;
                                }

                                div.innerHTML = innerHTML + `
                                    <div class="mt-1 flex justify-between items-start px-1">
                                        <span class="text-[10px] font-medium text-slate-600 dark:text-slate-400 truncate max-w-[80%]">${item.name || item.url}</span>
                                        <button onclick="App.ui.confirm('Deletar?', () => ${sectionId === 'videos' ? `App.ops.delVideo(${realIndex})` : `App.ops.delFile(${realIndex})`})" class="text-gray-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                                    </div>
                                `;
                                scrollBox.appendChild(div);
                            });
                        }

                        container.appendChild(scrollBox);
                    };

                    const vidGrid = $('files-videos-grid'); // legacy container cleanup
                    if (vidGrid) vidGrid.remove();
                    const imgGrid = $('files-images-grid');
                    if (imgGrid) imgGrid.parentElement.remove(); // Remove parent div logic
                    const pdfGrid = $('files-pdfs-grid');
                    if (pdfGrid) pdfGrid.parentElement.remove();

                    renderSection('videos', 'Vídeos', 'fas fa-play-circle text-red-600', [], null);
                    renderSection('images', 'Imagens', 'fas fa-image text-purple-500', [], null);
                    renderSection('pdfs', 'PDFs', 'fas fa-file-pdf text-red-500', [], null);
                },
                charts() {
                    const grid = $('charts-grid');
                    grid.innerHTML = '';
                    Object.keys(App.data.chartInstances).forEach(k => { if (k.startsWith('chart-')) App.data.chartInstances[k].destroy(); });

                    App.data.content[App.data.activeCatId].charts.forEach((c, idx) => {
                        const div = document.createElement('div');
                        div.className = "bg-white dark:bg-dark-surface p-4 rounded-2xl shadow border border-gray-100 dark:border-dark-border h-64 relative group";
                        div.innerHTML = `<h4 class="font-bold text-center mb-2 dark:text-white text-sm">${c.title}</h4><div class="h-48 relative"><canvas id="chart-thumb-${idx}"></canvas></div>`;

                        const delBtn = document.createElement('button');
                        delBtn.className = "absolute top-2 right-2 text-red-500 opacity-100 lg:opacity-0 group-hover:opacity-100 hover:scale-110 transition-all";
                        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        delBtn.onclick = () => App.charts.del(idx);

                        const editBtn = document.createElement('button');
                        editBtn.className = "absolute top-2 right-8 text-blue-500 opacity-100 lg:opacity-0 group-hover:opacity-100 hover:scale-110 transition-all";
                        editBtn.innerHTML = '<i class="fas fa-pen"></i>';
                        editBtn.onclick = () => App.charts.openBuilder(idx);

                        div.appendChild(delBtn);
                        div.appendChild(editBtn);
                        grid.appendChild(div);

                        setTimeout(() => {
                            const ctx = $(`chart-thumb-${idx}`);
                            if (ctx) {
                                const isCircular = ['pie', 'doughnut'].includes(c.type);
                                const isDark = document.documentElement.classList.contains('dark');
                                const textColor = isDark ? '#e2e8f0' : '#1e293b';

                                App.data.chartInstances[`chart-${idx}`] = new Chart(ctx, {
                                    type: c.type,
                                    data: {
                                        labels: c.labels,
                                        datasets: [{
                                            label: c.datasetName || 'Dados',
                                            data: c.data,
                                            backgroundColor: c.colors || c.color || '#8b5cf6',
                                            borderColor: c.colors || c.color || '#8b5cf6'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: true, position: 'top',
                                                labels: { color: textColor, generateLabels: (chart) => { const data = chart.data; if (data.labels.length && data.datasets.length) { return data.labels.map((label, i) => { const ds = data.datasets[0]; const bg = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i] : ds.backgroundColor; const border = Array.isArray(ds.borderColor) ? ds.borderColor[i] : ds.borderColor; return { text: label, fillStyle: bg, strokeStyle: border, lineWidth: 1, hidden: isNaN(ds.data[i]) || (chart.getDatasetMeta(0).data[i] && chart.getDatasetMeta(0).data[i].hidden), index: i }; }); } return []; }, onClick: (e, legendItem, legend) => { const index = legendItem.index; const ci = legend.chart; if (ci.isDatasetVisible(0)) { const meta = ci.getDatasetMeta(0); meta.data[index].hidden = !meta.data[index].hidden; ci.update(); } } }
                                            }
                                        },
                                        scales: isCircular ? { x: { display: false }, y: { display: false } } : { y: { max: c.yMax ? parseFloat(c.yMax) : undefined, ticks: { color: textColor } }, x: { ticks: { color: textColor } } }
                                    }
                                });
                            }
                        }, 50);
                    });
                }
            },

            editor: {
                open(id = null) {
                    App.data.currentDocId = id;
                    $('word-editor').classList.remove('hidden');
                    $('word-editor').classList.add('flex');
                    const doc = id ? App.data.content[App.data.activeCatId].notes.find(n => n.id === id) : { title: '', pages: [''], comments: [], chat: [] };
                    $('doc-title').value = doc.title;

                    const container = $('pages-container');
                    container.innerHTML = '';
                    container.contentEditable = true;
                    let debounceTimer;
                    container.oninput = (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            App.editor.sanitizeStructure();
                            App.editor.checkAllOverflows();
                            App.editor.updateWordCount();
                        }, 300);
                    };

                    container.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            document.execCommand('insertLineBreak');
                        }
                    };

                    // Re-add Paste Logic Here as backup/safety for direct container focus
                    container.onpaste = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const clipboardData = (e.originalEvent || e).clipboardData;
                        let html = clipboardData.getData('text/html');
                        let text = clipboardData.getData('text/plain');
                        let content = html || text;

                        if (html) {
                            // Strip forced colors so content inherits theme
                            content = content.replace(/background-color:\s*[^;"]+;?/gi, '');
                            content = content.replace(/background:\s*[^;"]+;?/gi, '');
                            content = content.replace(/color:\s*[^;"]+;?/gi, '');
                            document.execCommand('insertHTML', false, content);
                        } else {
                            document.execCommand('insertText', false, text);
                        }
                        setTimeout(() => {
                            App.editor.sanitizeStructure();
                            App.editor.checkAllOverflows();
                        }, 10);
                    };

                    (doc.pages.length ? doc.pages : ['']).forEach((content, i) => { this.createPageElement(content, i); });
                    this.renderComments(doc.comments || []);
                    $('ai-messages').innerHTML = '';
                    (doc.chat || []).forEach(m => App.ai.renderMsg(m));
                    this.updateWordCount();
                },
                sanitizeStructure() {
                    const container = $('pages-container');
                    const children = Array.from(container.childNodes);
                    let currentPage = null;

                    children.forEach(node => {
                        if (node.nodeType === 1 && node.classList.contains('page-break-marker')) return;
                        if (node.nodeType === 1 && node.classList.contains('a4-page')) { currentPage = node; }
                        else {
                            if (!currentPage) {
                                App.editor.addPage();
                                currentPage = container.querySelector('.a4-page');
                                currentPage.prepend(node);
                            } else { currentPage.appendChild(node); }
                        }
                    });
                },
                createPageElement(content, index) {
                    const container = $('pages-container');
                    if (index > 0) {
                        const br = document.createElement('div');
                        br.className = 'page-break-marker';
                        br.innerText = "Página " + (index + 1);
                        br.contentEditable = false;
                        container.appendChild(br);
                    }
                    const page = document.createElement('div');
                    page.className = 'a4-page';
                    page.innerHTML = content;
                    container.appendChild(page);
                },
                checkClick(e) { },
                checkAllOverflows() {
                    const pages = document.querySelectorAll('.a4-page');
                    for (let i = 0; i < pages.length; i++) {
                        let page = pages[i];
                        while (page.scrollHeight > page.clientHeight) {
                            const lastChild = page.lastElementChild;
                            if (lastChild) {
                                let nextPage = page.nextElementSibling;
                                if (nextPage && nextPage.classList.contains('page-break-marker')) nextPage = nextPage.nextElementSibling;
                                if (!nextPage || !nextPage.classList.contains('a4-page')) {
                                    App.editor.addPage();
                                    nextPage = page.nextElementSibling.nextElementSibling;
                                }
                                if (nextPage) nextPage.prepend(lastChild);
                            } else { break; }
                        }
                    }
                },
                addPage() { this.createPageElement('', document.querySelectorAll('.a4-page').length); },
                close() {
                    $('word-editor').classList.add('hidden');
                    $('word-editor').classList.remove('flex');
                    App.render.notes();
                    $('editor-sidebar').style.display = 'none';
                    $('editor-sidebar').classList.add('translate-x-full');
                },
                save() {
                    const title = $('doc-title').value || 'Sem Título';
                    const pages = Array.from(document.querySelectorAll('.a4-page')).map(p => p.innerHTML);
                    const catId = App.data.activeCatId;
                    let existingDoc = App.data.currentDocId ? App.data.content[catId].notes.find(n => n.id === App.data.currentDocId) : null;
                    const comments = existingDoc ? existingDoc.comments : [];
                    const chat = existingDoc ? existingDoc.chat : [];
                    const newDoc = {
                        id: App.data.currentDocId || uuid(),
                        title, pages, updated: Date.now(),
                        comments: comments, chat: chat
                    };
                    if (App.data.currentDocId) {
                        const idx = App.data.content[catId].notes.findIndex(n => n.id === App.data.currentDocId);
                        App.data.content[catId].notes[idx] = newDoc;
                    } else {
                        App.data.content[catId].notes.push(newDoc);
                        App.data.currentDocId = newDoc.id;
                    }
                    App.persist();
                    App.ui.toast('Documento salvo!');
                },
                delete(id) {
                    App.ui.confirm('Apagar documento?', () => {
                        App.data.content[App.data.activeCatId].notes = App.data.content[App.data.activeCatId].notes.filter(n => n.id !== id);
                        App.persist(); App.render.notes();
                    });
                },
                cmd(command, val = null) { document.execCommand(command, false, val); },
                updateWordCount() {
                    const text = Array.from(document.querySelectorAll('.a4-page')).map(p => p.innerText).join(' ');
                    const count = text.trim().split(/\s+/).filter(w => w.length > 0).length;
                    $('word-count').innerText = `${count} palavras`;
                },
                addAnnotation() {
                    const sel = window.getSelection();
                    if (!sel.rangeCount || sel.isCollapsed) return alert('Selecione texto para comentar.');
                    try {
                        const range = sel.getRangeAt(0);
                        const span = document.createElement('span');
                        const id = uuid();
                        span.className = 'annotation-highlight';
                        span.onclick = (e) => { e.stopPropagation(); App.editor.switchSide('comments'); };
                        range.surroundContents(span);
                        App.ui.modal('Comentário', 'Escreva...', (txt) => {
                            const catId = App.data.activeCatId;
                            let doc = App.data.content[catId].notes.find(n => n.id === App.data.currentDocId);
                            if (!doc) { App.editor.save(); doc = App.data.content[catId].notes.find(n => n.id === App.data.currentDocId); }
                            if (!doc.comments) doc.comments = [];
                            doc.comments.push({ id, text: txt, date: Date.now() });
                            App.editor.renderComments(doc.comments);
                            App.editor.switchSide('comments');
                            App.editor.toggleSidebar(true);
                            App.persist();
                        });
                    } catch (e) { alert('Seleção complexa demais. Tente selecionar apenas texto simples.'); }
                },
                deleteComment(id) {
                    App.ui.confirm('Excluir comentário?', () => {
                        const catId = App.data.activeCatId;
                        const docIdx = App.data.content[catId].notes.findIndex(n => n.id === App.data.currentDocId);
                        if (docIdx > -1) {
                            const doc = App.data.content[catId].notes[docIdx];
                            doc.comments = doc.comments.filter(c => c.id !== id);
                            this.renderComments(doc.comments);
                            App.persist();
                        }
                    });
                },
                renderComments(list) {
                    const el = $('comments-list');
                    el.innerHTML = '';
                    if (!list || list.length === 0) { el.innerHTML = '<p class="text-xs text-gray-400 text-center italic">Sem comentários.</p>'; return; }
                    list.forEach(c => {
                        const div = document.createElement('div');
                        div.className = "bg-white dark:bg-dark-surface p-3 rounded-lg shadow-sm border-l-4 border-yellow-400 text-sm dark:text-gray-300 relative group";
                        div.innerHTML = `<p class="font-bold text-[10px] text-gray-400 mb-1">${new Date(c.date).toLocaleTimeString()}</p><p>${c.text}</p>`;
                        const btn = document.createElement('button');
                        btn.className = "absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100";
                        btn.innerHTML = '<i class="fas fa-times"></i>';
                        btn.onclick = (e) => { e.stopPropagation(); App.editor.deleteComment(c.id); };
                        div.appendChild(btn); el.appendChild(div);
                    });
                },
                switchSide(panel) {
                    $('panel-ai').style.display = panel === 'ai' ? 'flex' : 'none';
                    $('panel-comments').style.display = panel === 'comments' ? 'block' : 'none';
                    $('btn-side-ai').className = panel === 'ai' ? 'flex-1 py-3 text-sm font-bold border-b-2 border-primary-500 text-primary-600' : 'flex-1 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 dark:text-gray-400';
                    $('btn-side-comments').className = panel === 'comments' ? 'flex-1 py-3 text-sm font-bold border-b-2 border-primary-500 text-primary-600' : 'flex-1 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 dark:text-gray-400';
                },
                toggleSidebar(forceOpen = false) {
                    const sb = $('editor-sidebar');
                    if (forceOpen) { sb.style.display = 'flex'; setTimeout(() => sb.classList.remove('translate-x-full'), 10); }
                    else {
                        if (sb.style.display === 'none') { sb.style.display = 'flex'; setTimeout(() => sb.classList.remove('translate-x-full'), 10); }
                        else { sb.classList.add('translate-x-full'); setTimeout(() => sb.style.display = 'none', 300); }
                    }
                },
                // FIX 2: Enhanced Export Logic
                exportWord() {
                    const clone = $('pages-container').cloneNode(true);

                    // 1. Remove UI markers
                    clone.querySelectorAll('.page-break-marker').forEach(el => el.remove());

                    // 2. Process all elements to fix colors for white paper
                    const allElements = clone.querySelectorAll('*');
                    allElements.forEach(el => {
                        // Remove background colors (often used for dark mode highlighting)
                        // But keep intended highlights if they are yellow/etc? 
                        // The user prompt implies fixing visual bugs. Usually Word docs are white background.
                        // Safest is to remove background-color unless it's a specific highlight (mark).
                        // For simplicity based on prompt: "Remove fundos que poderiam vir do Dark Mode"
                        el.style.backgroundColor = 'transparent';

                        // Handle Text Color
                        const style = el.getAttribute('style');
                        if (style && (style.includes('color:') || style.includes('COLOR:'))) {
                            // Get the inline color specifically
                            const inlineColor = el.style.color;

                            if (inlineColor) {
                                // Simple heuristic: if it looks like white or very light grey, make it black.
                                // We create a temporary element to let the browser compute the RGB value for us
                                // This handles 'white', '#fff', '#ffffff', 'rgb(255,255,255)' normalization.
                                const temp = document.createElement('div');
                                temp.style.color = inlineColor;
                                document.body.appendChild(temp);
                                const computed = window.getComputedStyle(temp).color;
                                document.body.removeChild(temp);

                                // computed is usually "rgb(r, g, b)"
                                const rgbMatch = computed.match(/\d+/g);
                                if (rgbMatch) {
                                    const r = parseInt(rgbMatch[0]);
                                    const g = parseInt(rgbMatch[1]);
                                    const b = parseInt(rgbMatch[2]);

                                    // Calculate brightness (YIQ formula)
                                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;

                                    // If bright ( > 200 is a safe bet for "near white"), force black
                                    // This catches white (#ffffff -> 255), light gray, etc.
                                    if (brightness > 200) {
                                        el.style.color = '#000000';
                                    }
                                }
                            }
                        }

                        // Also handle deprecated <font color="..."> tags if execCommand used them
                        if (el.tagName === 'FONT' && el.getAttribute('color')) {
                            const colorAttr = el.getAttribute('color');
                            if (colorAttr.toLowerCase() === '#ffffff' || colorAttr.toLowerCase() === 'white' || colorAttr.toLowerCase() === '#fff') {
                                el.setAttribute('color', '#000000');
                            }
                        }
                    });

                    const content = clone.innerHTML;

                    // Force Body Black Color in Word CSS
                    const header = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>Export</title><style>body { font-family: "Merriweather", serif; color: #000000 !important; background-color: #ffffff !important; } .a4-page { margin: 0; padding: 0; box-shadow: none; border: none; background: white !important; color: black !important; } /* Ensure text defaults to black */ p, span, div, li, td { color: #000000; } </style></head><body>';
                    const footer = '</body></html>';
                    const blob = new Blob([header + content + footer], { type: 'application/msword' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = ($('doc-title').value || 'documento') + '.doc';
                    link.click();
                }
            },

            ai: {
                renderMsg(msg) {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg text-sm mb-2 ai-msg-content ${msg.role === 'user' ? 'bg-primary-600 text-white self-end ml-4' : 'bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border mr-4 text-slate-700 dark:text-slate-300'}`;
                    if (msg.type === 'quiz_trigger') {
                        App.data.currentQuizData = msg.data;
                        div.innerHTML = `<p class="mb-2 font-bold"><i class="fas fa-brain"></i> Quiz Gerado!</p><button onclick='App.ai.openQuizModal(App.data.currentQuizData)' class="bg-pink-500 text-white px-4 py-2 rounded-full font-bold shadow hover:bg-pink-600 w-full">Abrir Quiz Interativo</button>`;
                    } else { div.innerHTML = marked.parse(msg.content); }
                    $('ai-messages').appendChild(div);
                    $('ai-messages').scrollTop = $('ai-messages').scrollHeight;
                },
                async send() {
                    if (!App.data.apiKey && !window.userApiKey) return App.ui.toast("Configure sua API Key primeiro!", "error");
                    const txt = $('ai-input').value;
                    if (!txt) return;
                    $('ai-input').value = '';
                    const userMsg = { role: 'user', content: txt };
                    this.renderMsg(userMsg);
                    const context = Array.from(document.querySelectorAll('.a4-page')).map(p => p.innerText).join('\n').substring(0, 5000);
                    const prompt = `Instrução: Responda com parágrafos curtos, tópicos e bom espaçamento visual. Texto do documento: "${context}". Pergunta do usuário: "${txt}". Responda de forma útil.`;
                    this.callGemini(prompt, userMsg);
                },
                quick(type) {
                    if (!App.data.apiKey && !window.userApiKey) return App.ui.toast("Configure sua API Key primeiro!", "error");
                    const context = Array.from(document.querySelectorAll('.a4-page')).map(p => p.innerText).join('\n').substring(0, 5000);
                    if (!context || context.trim().length < 5) return App.ui.toast("Documento vazio ou editor fechado.", "error");

                    const baseInst = "Instrução de Formatação: Use markdown. Separe bem os parágrafos. Use listas com marcadores (-) sempre que possível. Evite blocos de texto denso. ";

                    if (type === 'quiz') {
                        App.ui.modal('Criar Quiz', 'Quantas questões? (Ex: 3)', (val) => {
                            const qCount = parseInt(val) || 3;
                            const prompt = `Crie um quiz com exatas ${qCount} perguntas de múltipla escolha baseadas no seguinte texto: "${context}". Retorne APENAS um JSON puro (sem markdown, sem \`\`\`) neste formato exato: [{"q":"Pergunta","options":["A","B","C"],"correct":0}]`;
                            this.renderMsg({ role: 'user', content: `[Criar Quiz com ${qCount} questões]` });
                            this.callGemini(prompt, { role: 'user', content: `[Criar Quiz (${qCount})]` }, true);
                        });
                        return;
                    }

                    let prompt = "";
                    let displayMsg = "";
                    if (type === 'summary') {
                        prompt = `${baseInst} Ação: Resuma o texto a seguir de forma concisa. No final, adicione um tópico chamado **Explicação Breve**. Texto: "${context}"`;
                        displayMsg = "[Resumir Documento]";
                    } else if (type === 'fix') {
                        prompt = `${baseInst} Ação: Corrija ortografia e gramática. Texto: "${context}"`;
                        displayMsg = "[Corrigir Ortografia]";
                    } else if (type === 'analyze') {
                        prompt = `${baseInst} Ação: Analise como uma banca de redação. Dê nota (0-1000) e pontos de melhoria. Texto: "${context}"`;
                        displayMsg = "[Analisar Redação]";
                    }
                    this.renderMsg({ role: 'user', content: displayMsg });
                    this.callGemini(prompt, { role: 'user', content: displayMsg });
                },
                async callGemini(prompt, userMsgObj, isJson = false) {
                    const key = App.data.apiKey || window.userApiKey;
                    const loadDiv = document.createElement('div'); loadDiv.className = "flex justify-center p-2"; loadDiv.innerHTML = '<div class="loader"></div>'; $('ai-messages').appendChild(loadDiv);
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await res.json();
                        loadDiv.remove();
                        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro.";
                        let aiMsg;
                        if (isJson) {
                            try {
                                const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                                const json = JSON.parse(jsonStr);
                                aiMsg = { role: 'ai', content: 'Quiz Pronto', type: 'quiz_trigger', data: json };
                            } catch (err) { aiMsg = { role: 'ai', content: "Erro ao gerar formato do Quiz. Tente novamente." }; }
                        } else { aiMsg = { role: 'ai', content: text }; }
                        this.renderMsg(aiMsg);
                        const docIdx = App.data.content[App.data.activeCatId].notes.findIndex(n => n.id === App.data.currentDocId);
                        if (docIdx > -1) {
                            if (!App.data.content[App.data.activeCatId].notes[docIdx].chat) App.data.content[App.data.activeCatId].notes[docIdx].chat = [];
                            App.data.content[App.data.activeCatId].notes[docIdx].chat.push(userMsgObj, aiMsg);
                        }
                    } catch (e) { loadDiv.remove(); App.ui.toast("Erro na IA. Verifique sua chave.", "error"); }
                },
                openQuizModal(quizData) {
                    App.data.currentQuiz = quizData;
                    $('quiz-content').innerHTML = quizData.map((q, i) => `
                        <div class="bg-gray-50 dark:bg-black/20 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                            <p class="font-bold mb-3 dark:text-white">${i + 1}. ${q.q}</p>
                            <div class="space-y-2">
                                ${q.options.map((opt, oi) => `
                                    <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                                        <input type="radio" name="q${i}" value="${oi}" class="w-4 h-4 text-primary-600">
                                        <span class="dark:text-gray-300 text-sm">${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                    $('quiz-result').classList.add('hidden');
                    $('btn-check-quiz').classList.remove('hidden');
                    $('modal-quiz').classList.remove('hidden');
                    $('modal-quiz').classList.add('flex');
                },
                checkQuiz() {
                    let score = 0;
                    App.data.currentQuiz.forEach((q, i) => {
                        const selected = document.querySelector(`input[name="q${i}"]:checked`);
                        const container = document.getElementsByName(`q${i}`)[0].closest('.space-y-2');
                        const labels = container.querySelectorAll('label');
                        labels[q.correct].classList.add('bg-green-100', 'border-green-500', 'dark:bg-green-900/30', 'dark:border-green-500');
                        if (selected) {
                            if (parseInt(selected.value) === q.correct) score++;
                            else labels[selected.value].classList.add('bg-red-100', 'border-red-500', 'dark:bg-red-900/30', 'dark:border-red-500');
                        }
                    });
                    $('quiz-score').innerText = `Você acertou ${score} de ${App.data.currentQuiz.length}`;
                    $('quiz-result').classList.remove('hidden');
                    $('btn-check-quiz').classList.add('hidden');
                }
            },

            charts: {
                colors: ['#8b5cf6', '#ec4899', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#6366f1'],
                state: { editingIdx: null },
                openBuilder(idx = null) {
                    App.charts.state.editingIdx = idx;
                    $('modal-chart').classList.remove('hidden');
                    $('modal-chart').classList.add('flex');
                    $('chart-rows').innerHTML = '';
                    if (idx !== null) {
                        const chart = App.data.content[App.data.activeCatId].charts[idx];
                        $('chart-title').value = chart.title; $('chart-type').value = chart.type; $('chart-ymax').value = chart.yMax || '';
                        chart.labels.forEach((lbl, i) => {
                            const val = chart.data[i];
                            const col = (Array.isArray(chart.colors) ? chart.colors[i] : chart.colors) || '#8b5cf6';
                            App.charts.addRow(lbl, val, col);
                        });
                    } else { $('chart-title').value = ''; $('chart-type').value = 'bar'; $('chart-ymax').value = ''; App.charts.addRow(); App.charts.addRow(); }
                    App.charts.preview();
                },
                addRow(l = '', v = '', c = null) {
                    const div = document.createElement('div');
                    const rowCount = document.querySelectorAll('.row-data').length;
                    const autoColor = c || App.charts.colors[rowCount % App.charts.colors.length];
                    div.className = "flex gap-2 row-data mb-2 items-center";
                    div.innerHTML = `
                        <input type="color" class="chart-input-color w-8 h-8 rounded cursor-pointer border-0 p-0" value="${autoColor}" oninput="App.charts.preview()">
                        <input type="text" class="chart-input-name flex-1 p-2 rounded border dark:bg-black/20 dark:border-gray-700 dark:text-white text-sm" placeholder="Nome" value="${l}" oninput="App.charts.preview()">
                        <input type="number" class="chart-input-value w-20 p-2 rounded border dark:bg-black/20 dark:border-gray-700 dark:text-white text-sm" placeholder="Val" value="${v}" oninput="App.charts.preview()">
                        <button onclick="this.parentElement.remove(); App.charts.preview()" class="text-red-500 font-bold px-2 hover:bg-red-50 rounded"><i class="fas fa-times"></i></button>
                    `;
                    $('chart-rows').appendChild(div);
                },
                preview() {
                    const ctx = $('chart-canvas');
                    const inputs = document.querySelectorAll('#chart-rows .row-data');
                    const lbls = [], vals = [], colors = [];
                    inputs.forEach(row => {
                        const nameInput = row.querySelector('.chart-input-name');
                        const valInput = row.querySelector('.chart-input-value');
                        const colInput = row.querySelector('.chart-input-color');
                        if (nameInput && valInput) { lbls.push(nameInput.value); vals.push(valInput.value); colors.push(colInput.value); }
                    });
                    const type = $('chart-type').value;
                    const title = $('chart-title').value || "Pré-visualização";
                    const yMax = $('chart-ymax').value;
                    const isCircular = ['pie', 'doughnut'].includes(type);
                    if (this.tempPreview) this.tempPreview.destroy();
                    const isDark = document.documentElement.classList.contains('dark');
                    const textColor = isDark ? '#e2e8f0' : '#1e293b';

                    this.tempPreview = new Chart(ctx, {
                        type,
                        data: { labels: lbls, datasets: [{ label: 'Dados', data: vals, backgroundColor: colors, borderColor: colors, borderWidth: 1 }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true, position: 'top',
                                    labels: { color: textColor, generateLabels: (chart) => { const data = chart.data; if (data.labels.length && data.datasets.length) { return data.labels.map((label, i) => { const ds = data.datasets[0]; const bg = Array.isArray(ds.backgroundColor) ? ds.backgroundColor[i] : ds.backgroundColor; const border = Array.isArray(ds.borderColor) ? ds.borderColor[i] : ds.borderColor; return { text: label, fillStyle: bg, strokeStyle: border, lineWidth: 1, hidden: isNaN(ds.data[i]) || (chart.getDatasetMeta(0).data[i] && chart.getDatasetMeta(0).data[i].hidden), index: i }; }); } return []; }, onClick: (e, legendItem, legend) => { const index = legendItem.index; const ci = legend.chart; if (ci.isDatasetVisible(0)) { const meta = ci.getDatasetMeta(0); meta.data[index].hidden = !meta.data[index].hidden; ci.update(); } } }
                                }
                            },
                            scales: isCircular ? { x: { display: false }, y: { display: false } } : { y: { max: yMax ? parseFloat(yMax) : undefined, ticks: { color: textColor } }, x: { ticks: { color: textColor } } }
                        }
                    });
                },
                download() {
                    const canvas = $('chart-canvas');
                    const link = document.createElement('a');
                    link.download = ($('chart-title').value || 'grafico') + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                },
                save() {
                    const inputs = document.querySelectorAll('#chart-rows .row-data');
                    const lbls = [], vals = [], colors = [];
                    inputs.forEach(row => {
                        const nameInput = row.querySelector('.chart-input-name');
                        const valInput = row.querySelector('.chart-input-value');
                        const colInput = row.querySelector('.chart-input-color');
                        if (nameInput && valInput) { const l = nameInput.value; const v = valInput.value; if (l && v) { lbls.push(l); vals.push(v); colors.push(colInput.value); } }
                    });
                    const type = $('chart-type').value;
                    const title = $('chart-title').value || 'Gráfico';
                    const yMax = $('chart-ymax').value;
                    if (lbls.length === 0) return App.ui.toast("Adicione dados.", "error");
                    const chartData = { title, type, labels: lbls, data: vals, colors, yMax, datasetName: 'Dados' };
                    if (App.charts.state.editingIdx !== null) { App.data.content[App.data.activeCatId].charts[App.charts.state.editingIdx] = chartData; }
                    else { App.data.content[App.data.activeCatId].charts.push(chartData); }
                    App.persist(); App.render.charts(); $('modal-chart').classList.add('hidden');
                },
                del(idx) {
                    App.ui.confirm('Excluir gráfico?', () => {
                        App.data.content[App.data.activeCatId].charts.splice(idx, 1);
                        App.persist(); App.render.charts();
                    });
                }
            },
            viewer: {
                open(data, type, name) {
                    const m = $('modal-viewer');
                    const c = $('viewer-content');
                    $('viewer-title').innerText = name || "Arquivo";
                    if (type === 'img') c.innerHTML = `<img src="${data}" class="max-w-full max-h-[85vh] rounded shadow-lg object-contain">`;
                    m.classList.remove('hidden'); m.classList.add('flex');
                },
                openPDF(data) {
                    const byteCharacters = atob(data.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const blobUrl = URL.createObjectURL(blob);
                    window.open(blobUrl, '_blank');
                }
            },
            pomo: {
                time: 25 * 60, active: false,
                setCustomTime() { App.ui.modal('Tempo (minutos)', 'Ex: 60', val => { const mins = parseInt(val); if (!isNaN(mins) && mins > 0) { this.active = false; this.time = mins * 60; this.render(); $('pomo-btn').innerHTML = '<i class="fas fa-play text-xs ml-0.5"></i>'; } }); },
                toggle() { this.active = !this.active; $('pomo-btn').innerHTML = this.active ? '<i class="fas fa-pause text-xs"></i>' : '<i class="fas fa-play text-xs ml-0.5"></i>'; },
                reset() { this.active = false; this.time = 25 * 60; this.render(); $('pomo-btn').innerHTML = '<i class="fas fa-play text-xs ml-0.5"></i>'; },
                tick() { if (this.active && this.time > 0) { this.time--; this.render(); if (this.time === 0) { App.ui.toast("Tempo Esgotado!"); this.active = false; this.reset(); } } },
                render() { const h = Math.floor(this.time / 3600); const m = Math.floor((this.time % 3600) / 60).toString().padStart(2, '0'); const s = (this.time % 60).toString().padStart(2, '0'); $('pomo-timer').innerText = h > 0 ? `${h}:${m}:${s}` : `${m}:${s}`; }
            }
        };

        document.querySelectorAll('.tool-btn').forEach(b => { if (!b.className.includes('w-8')) b.className += " w-8 h-8 flex items-center justify-center rounded hover:bg-gray-200 dark:hover:bg-white/10 text-slate-700 dark:text-gray-300 transition-colors mx-0.5 text-sm"; });
        document.querySelectorAll('.btn-secondary').forEach(b => b.className = "bg-white dark:bg-dark-surface border border-gray-300 dark:border-dark-border text-slate-700 dark:text-white font-bold rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-white/10 transition-all py-2 px-3 flex items-center gap-2");

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>